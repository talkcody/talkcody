# TalkCody å¤šä»»åŠ¡å¹¶å‘æ”¯æŒæ–¹æ¡ˆ

## æ¦‚è¿°

æ”¯æŒç”¨æˆ·åŒæ—¶è¿è¡Œå¤šä¸ª Taskï¼ˆå¦‚åŒæ—¶å†™æµ‹è¯•ã€å†™ä»£ç ã€å†™æ–‡æ¡£ï¼‰ï¼Œæ¯ä¸ª Task åœ¨ç‹¬ç«‹çš„ Git åˆ†æ”¯ä¸Šå·¥ä½œï¼Œé€šè¿‡å¤šæ ‡ç­¾é¡µ UI è¿›è¡Œç®¡ç†ã€‚

## å…³é”®è®¾è®¡å†³ç­–

- **åˆ†æ”¯åˆ›å»º**ï¼šè‡ªåŠ¨åˆ›å»ºï¼ˆåˆ›å»º Task æ—¶è‡ªåŠ¨ä»å½“å‰åˆ†æ”¯åˆ›å»ºæ–°åˆ†æ”¯ï¼‰
- **å¹¶å‘é™åˆ¶**ï¼šæœ€å¤š 3 ä¸ª Task åŒæ—¶è¿è¡Œ
- **ç‰©ç†éš”ç¦»**ï¼šä½¿ç”¨ **Git Worktree Pool**ï¼ˆå›ºå®š 3 ä¸ª slotï¼Œå¤ç”¨è€Œéæ¯æ¬¡åˆ›å»ºï¼‰
- **UI å¸ƒå±€**ï¼šå¤šæ ‡ç­¾é¡µ
- **çŠ¶æ€åŒºåˆ†**ï¼š`focusedTaskId`ï¼ˆå½“å‰æŸ¥çœ‹ï¼‰vs `runningTaskIds`ï¼ˆæ‰€æœ‰è¿è¡Œä¸­ï¼‰

## Git Worktree Pool æ–¹æ¡ˆ

é‡‡ç”¨å›ºå®šæ•°é‡çš„ Worktree Slotï¼Œå¤ç”¨è€Œéæ¯æ¬¡åˆ›å»ºæ–° worktreeï¼ˆé¿å…å¤§é¡¹ç›®çš„é«˜ä»£ä»·ï¼‰ï¼š

```
project/                          # ä¸»å·¥ä½œç›®å½• (main åˆ†æ”¯)
â”œâ”€â”€ .git/                         # å…±äº«çš„ Git æ•°æ®åº“
â”œâ”€â”€ .worktrees/                   # å›ºå®šçš„ Worktree Pool
â”‚   â”œâ”€â”€ slot-0/                   # Slot 0 (å¯èƒ½è¢« Task A å ç”¨)
â”‚   â”œâ”€â”€ slot-1/                   # Slot 1 (å¯èƒ½è¢« Task B å ç”¨)
â”‚   â””â”€â”€ slot-2/                   # Slot 2 (ç©ºé—²)
â”œâ”€â”€ src/
â””â”€â”€ tests/
```

**Slot åˆ†é…æµç¨‹**ï¼š
```
åˆ›å»º Task
    â†“
æŸ¥æ‰¾ç©ºé—² slotï¼ˆstatus === 'idle'ï¼‰
    â†“
å¦‚æœæ²¡æœ‰ç©ºé—² slot â†’ è¿”å›é”™è¯¯ "å·²è¾¾æœ€å¤§å¹¶å‘æ•°"
    â†“
åœ¨è¯¥ slot ä¸­ï¼šgit checkout -b task/{name}-{id}
    â†“
æ ‡è®° slot ä¸º occupiedï¼Œå…³è” taskId
    â†“
Agent åœ¨è¯¥ slot ç›®å½•ä¸­å·¥ä½œ
    â†“
Task å®Œæˆ/å–æ¶ˆ
    â†“
git checkout main && git clean -fd  # æ¸…ç† slot
    â†“
æ ‡è®° slot ä¸º idleï¼Œç­‰å¾…å¤ç”¨
```

**Slot æ•°æ®ç»“æ„**ï¼š
```typescript
interface WorktreeSlot {
  id: number;              // 0, 1, 2
  path: string;            // .worktrees/slot-0
  status: 'idle' | 'occupied';
  taskId: string | null;   // å½“å‰å ç”¨çš„ Task ID
  branchName: string | null;
}
```

**ä¼˜åŠ¿**ï¼š
- **å¤ç”¨æˆæœ¬ä½**ï¼š`git checkout` æ¯” `git worktree add` å¿«å¾—å¤š
- çœŸæ­£çš„ç‰©ç†éš”ç¦»ï¼Œå¤šä¸ª Task å¯ä»¥åŒæ—¶å†™å…¥ä¸åŒç›®å½•
- æ¯ä¸ª Task å¯ä»¥ç‹¬ç«‹è¿è¡Œæµ‹è¯•ã€linter ç­‰å¤–éƒ¨å·¥å…·
- å›ºå®šçš„èµ„æºå ç”¨ï¼Œå¯é¢„æµ‹

## æ ¸å¿ƒæ¦‚å¿µï¼šTask

```typescript
interface Task {
  id: string;
  name: string;
  conversationId: string;
  branchName: string;           // Git åˆ†æ”¯åç§° (å¦‚ task/write-tests-abc123)
  baseBranch: string;           // åŸºäºå“ªä¸ªåˆ†æ”¯åˆ›å»º
  slotId: number;               // å ç”¨çš„ Worktree Slot ID (0, 1, 2)
  status: 'pending' | 'running' | 'paused' | 'completed' | 'failed';
  workingFiles: string[];       // è¯¥ task æ­£åœ¨æ“ä½œçš„æ–‡ä»¶åˆ—è¡¨
  createdAt: number;
  lastActiveAt: number;
}

interface TaskManagerState {
  tasks: Map<string, Task>;
  slots: WorktreeSlot[];        // å›ºå®š 3 ä¸ª slot
  focusedTaskId: string | null; // å½“å‰ç”¨æˆ·æŸ¥çœ‹çš„ Tab

  // Computed
  getRunningTasks(): Task[];    // æ‰€æœ‰ status === 'running' çš„ tasks
  getIdleSlot(): WorktreeSlot | null;
}
```

## æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        UI Layer                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Tab 1   â”‚ â”‚ Tab 2   â”‚ â”‚ Tab 3   â”‚ â”‚   +     â”‚           â”‚
â”‚  â”‚ Task A  â”‚ â”‚ Task B  â”‚ â”‚ Task C  â”‚ â”‚ New Taskâ”‚           â”‚
â”‚  â”‚ focused â”‚ â”‚ running â”‚ â”‚ running â”‚ â”‚         â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚          â”‚          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Task Manager Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚                  TaskManagerStore                         â”‚
â”‚  â”‚  - tasks: Map<taskId, Task>                              â”‚
â”‚  â”‚  - slots: WorktreeSlot[3]  (å›ºå®š 3 ä¸ª slot)              â”‚
â”‚  â”‚  - focusedTaskId: string   (å½“å‰æŸ¥çœ‹çš„ Tab)              â”‚
â”‚  â”‚  - createTask() / completeTask() / cancelTask()          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Agent Execution Layer                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚            MultiAgentExecutionStore                       â”‚
â”‚  â”‚  - instances: Map<taskId, AgentInstance>                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ AgentInstance  â”‚  â”‚ AgentInstance  â”‚  â”‚ AgentInstance  â”‚ â”‚
â”‚  â”‚ (Task A)       â”‚  â”‚ (Task B)       â”‚  â”‚ (Task C)       â”‚ â”‚
â”‚  â”‚ - llmService   â”‚  â”‚ - llmService   â”‚  â”‚ - llmService   â”‚ â”‚
â”‚  â”‚ - streamProc   â”‚  â”‚ - streamProc   â”‚  â”‚ - streamProc   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Git Branch Layer                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚                 GitBranchService                          â”‚
â”‚  â”‚  - createTaskBranch(taskId, baseBranch)                  â”‚
â”‚  â”‚  - switchBranch(branchName)                              â”‚
â”‚  â”‚  - stashChanges() / popStash()                           â”‚
â”‚  â”‚  - mergeBranch(source, target)                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å®ç°é˜¶æ®µ

### é˜¶æ®µ 1ï¼šåŸºç¡€æ¶æ„

1. **åˆ›å»º TaskManagerStore** (`src/stores/task-manager-store.ts`)
   - Task CRUD æ“ä½œ
   - ä¸æ•°æ®åº“é›†æˆæŒä¹…åŒ–

2. **åˆ›å»º MultiAgentExecutionStore** (`src/stores/multi-agent-execution-store.ts`)
   - ç®¡ç†å¤šä¸ª AgentInstance
   - æ¯ä¸ªå®ä¾‹åŒ…å«ç‹¬ç«‹çš„ LLMServiceã€StreamProcessor

3. **é‡æ„ LLMService ä¸ºå¯å®ä¾‹åŒ–**
   - å°†å•ä¾‹æ”¹ä¸ºå·¥å‚å‡½æ•°/ç±»
   - StreamProcessor ä»å•ä¾‹æ”¹ä¸ºå®ä¾‹

### é˜¶æ®µ 2ï¼šGit Worktree æ”¯æŒ

1. **Rust åç«¯æ‰©å±•** (`src-tauri/src/git/worktree.rs`)
   - `git_worktree_add(repo_path, worktree_path, branch_name, base_branch)` - åˆ›å»º worktree
   - `git_worktree_remove(repo_path, worktree_path)` - åˆ é™¤ worktree
   - `git_worktree_list(repo_path)` - åˆ—å‡ºæ‰€æœ‰ worktree
   - `git_merge_branch(repo_path, source_branch, target_branch)` - åˆå¹¶åˆ†æ”¯
   - `git_delete_branch(repo_path, branch_name)` - åˆ é™¤åˆ†æ”¯

2. **å‰ç«¯ WorktreeService** (`src/services/worktree-service.ts`)
   - å°è£… Rust å‘½ä»¤è°ƒç”¨
   - Task åˆ›å»ºæ—¶è‡ªåŠ¨åˆ›å»º worktree
   - Worktree è·¯å¾„è§„åˆ™ï¼š`{project}/.worktrees/task-{taskId}/`
   - åˆ†æ”¯å‘½åè§„åˆ™ï¼š`task/{taskName}-{taskId}`

### é˜¶æ®µ 3ï¼šå¤šæ ‡ç­¾é¡µ UI

**UI æ¨¡å¼**ï¼šå•ä»»åŠ¡æ¨¡å¼ vs å¤šä»»åŠ¡æ¨¡å¼ï¼ˆæ›¿æ¢æ¨¡å¼ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å•ä»»åŠ¡æ¨¡å¼ (ç°æœ‰)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ NavigationSidebar â”‚ ChatHistorySidebar â”‚      ChatBox                   â”‚
â”‚                   â”‚ (å¯¹è¯å†å²åˆ—è¡¨)       â”‚   (å•ä¸ªå¯¹è¯)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              â†“ ç‚¹å‡» "Multi-Task" æŒ‰é’®

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å¤šä»»åŠ¡æ¨¡å¼ (æ–°å¢)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ NavigationSidebar â”‚ Task Tabs                                           â”‚
â”‚                   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”                â”‚
â”‚                   â”‚ â”‚ğŸŸ¢Task 1 â”‚ğŸŸ¢Task 2 â”‚ğŸŸ¡Task 3 â”‚ + â”‚                â”‚
â”‚                   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”˜                â”‚
â”‚                   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                   â”‚ â”‚           TaskChatPanel                        â”‚ â”‚
â”‚                   â”‚ â”‚        (focused Task çš„å¯¹è¯)                    â”‚ â”‚
â”‚                   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Task Tab çŠ¶æ€æŒ‡ç¤ºå™¨**ï¼š
- ğŸŸ¢ running - æ­£åœ¨æ‰§è¡Œ
- ğŸŸ¡ paused - å·²æš‚åœ
- âœ… completed - å·²å®Œæˆ
- âŒ failed - å¤±è´¥

**Tab å†…å®¹**ï¼š
- Task åç§°
- åˆ†æ”¯ä¿¡æ¯ (baseBranch â†’ taskBranch)
- å…³é—­æŒ‰é’® [x]

**äº¤äº’**ï¼š
- ç‚¹å‡» Tab åˆ‡æ¢ focusedTaskId
- ç‚¹å‡» [+] åˆ›å»ºæ–° Task
- ç‚¹å‡» [x] å…³é—­ Taskï¼ˆå¼¹å‡ºç¡®è®¤ï¼šåˆå¹¶/æ”¾å¼ƒ/å–æ¶ˆï¼‰
- æ‹–æ‹½ Tab è°ƒæ•´é¡ºåº

1. **TaskTabs ç»„ä»¶** (`src/components/task-tabs.tsx`)
   - æ ‡ç­¾é¡µå®¹å™¨
   - æ˜¾ç¤º Task çŠ¶æ€æŒ‡ç¤ºå™¨
   - æ–°å»º/å…³é—­ Task æ“ä½œ

2. **TaskChatPanel ç»„ä»¶** (`src/components/task-chat-panel.tsx`)
   - åŸºäº ChatBox é‡æ„
   - æ¥æ”¶ taskId å‚æ•°
   - ä½¿ç”¨å¯¹åº” slot çš„ worktree è·¯å¾„

3. **MultiTaskPage ç»„ä»¶** (`src/pages/multi-task-page.tsx`)
   - å¤šä»»åŠ¡æ¨¡å¼çš„é¡µé¢å®¹å™¨
   - ç®¡ç† TaskTabs + TaskChatPanel

4. **æ¨¡å¼åˆ‡æ¢**
   - åœ¨ NavigationSidebar æˆ– ChatToolbar æ·»åŠ  "Multi-Task" æŒ‰é’®
   - åˆ‡æ¢æ—¶éšè— ChatHistorySidebarï¼Œæ˜¾ç¤º TaskTabs

### é˜¶æ®µ 4ï¼šTask ç”Ÿå‘½å‘¨æœŸç®¡ç†

1. **Task æš‚åœ/æ¢å¤**
   - stash å½“å‰åˆ†æ”¯æ›´æ”¹
   - åˆ‡æ¢åˆ†æ”¯

2. **Task å®Œæˆåå¤„ç†**
   - åˆå¹¶åˆ†æ”¯åˆ°ç›®æ ‡åˆ†æ”¯
   - å†²çªå¤„ç† UI

3. **å¹¶å‘é™åˆ¶**
   - æœ€å¤§å¹¶å‘ Task æ•°é‡é™åˆ¶

## å…³é”®æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|----------|------|
| `src/stores/task-manager-store.ts` | Task ç®¡ç† + Slot Pool ç®¡ç† |
| `src/stores/multi-agent-execution-store.ts` | å¤š Agent å®ä¾‹ç®¡ç† |
| `src/services/worktree-service.ts` | Git Worktree Pool æ“ä½œæœåŠ¡ |
| `src/pages/multi-task-page.tsx` | å¤šä»»åŠ¡æ¨¡å¼é¡µé¢ |
| `src/components/task-tabs.tsx` | Task æ ‡ç­¾é¡µæ  |
| `src/components/task-chat-panel.tsx` | å•ä¸ª Task èŠå¤©é¢æ¿ |
| `src/components/task-close-dialog.tsx` | å…³é—­ Task ç¡®è®¤å¯¹è¯æ¡† |
| `src-tauri/src/git/worktree.rs` | Rust Git Worktree å‘½ä»¤ |
| `src/types/task.ts` | Taskã€WorktreeSlot ç±»å‹å®šä¹‰ |

### éœ€ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹å†…å®¹ |
|----------|----------|
| `src/stores/agent-execution-store.ts` | åºŸå¼ƒæˆ–æ”¹ä¸ºå…¼å®¹å±‚ |
| `src/services/agents/llm-service.ts` | æ”¹ä¸ºå¯å®ä¾‹åŒ–ç±» |
| `src/services/agents/stream-processor.ts` | ç§»é™¤å•ä¾‹æ¨¡å¼ |
| `src/pages/chat-page.tsx` | é›†æˆå¤šæ ‡ç­¾é¡µ |
| `src/components/chat-box.tsx` | æ¥æ”¶ taskId å‚æ•° |
| `src-tauri/src/git/mod.rs` | å¯¼å‡ºæ–°å‘½ä»¤ |
| `src-tauri/src/lib.rs` | æ³¨å†Œæ–°å‘½ä»¤ |

## æ•°æ®åº“ Schema æ‰©å±•

```sql
CREATE TABLE IF NOT EXISTS tasks (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  conversation_id TEXT REFERENCES conversations(id),
  branch_name TEXT NOT NULL,
  base_branch TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'pending',
  working_files TEXT, -- JSON array
  created_at INTEGER NOT NULL,
  last_active_at INTEGER NOT NULL,
  project_id TEXT REFERENCES projects(id)
);

CREATE INDEX idx_tasks_project ON tasks(project_id);
CREATE INDEX idx_tasks_status ON tasks(status);
```

## é£é™©ä¸æ³¨æ„äº‹é¡¹

1. **å†…å­˜å ç”¨**ï¼šå¤šä¸ª AgentInstance åŒæ—¶è¿è¡Œä¼šå¢åŠ å†…å­˜ï¼Œé™åˆ¶æœ€å¤§ 3 ä¸ªå¹¶å‘
2. **ç£ç›˜ç©ºé—´**ï¼šWorktree Pool å›ºå®šå ç”¨ 3 å€é¡¹ç›®å¤§å°ï¼Œä½†ä¸€æ¬¡æ€§åˆ›å»ºåå¯å¤ç”¨
3. **åˆå¹¶å†²çª**ï¼šTask å®Œæˆåˆå¹¶æ—¶å¯èƒ½äº§ç”Ÿå†²çªï¼Œéœ€è¦å®ç°å†²çªè§£å†³ UI
4. **æ–‡ä»¶ç¼“å­˜éš”ç¦»**ï¼šæ¯ä¸ª Task çš„ RepositoryService éœ€è¦ä½¿ç”¨å¯¹åº” slot è·¯å¾„
5. **Slot æ¸…ç†**ï¼šTask å®Œæˆ/å–æ¶ˆæ—¶éœ€è¦æ­£ç¡®æ¸…ç† slot ä¸­çš„æœªæäº¤å˜æ›´
6. **Pool åˆå§‹åŒ–**ï¼šé¦–æ¬¡ä½¿ç”¨å¤šä»»åŠ¡æˆ–åˆ‡æ¢é¡¹ç›®æ—¶ï¼Œéœ€è¦åˆå§‹åŒ– Worktree Pool

## Task ç”Ÿå‘½å‘¨æœŸ

```
åˆ›å»º Task
    â†“
æŸ¥æ‰¾ç©ºé—² slot (getIdleSlot())
    â†“
å¦‚æœæ— ç©ºé—² â†’ æç¤º "å·²è¾¾æœ€å¤§å¹¶å‘æ•°(3)"
    â†“
åœ¨ slot ä¸­åˆ›å»ºæ–°åˆ†æ”¯: git checkout -b task/{name}-{id}
    â†“
æ ‡è®° slot.status = 'occupied', slot.taskId = task.id
    â†“
Agent åœ¨ slot ç›®å½•ä¸­å·¥ä½œ (.worktrees/slot-{n}/)
    â†“
Task å®Œæˆ
    â†“
ç”¨æˆ·é€‰æ‹©ï¼šåˆå¹¶åˆ° base åˆ†æ”¯ / ä¿æŒç‹¬ç«‹ / æ”¾å¼ƒ
    â†“
æ¸…ç† slot: git checkout {baseBranch} && git clean -fd
    â†“
æ ‡è®° slot.status = 'idle', slot.taskId = null
```

**åˆå§‹åŒ– Worktree Pool**ï¼ˆé¦–æ¬¡ä½¿ç”¨æˆ–é¡¹ç›®åˆ‡æ¢æ—¶ï¼‰ï¼š
```bash
git worktree add .worktrees/slot-0 main
git worktree add .worktrees/slot-1 main
git worktree add .worktrees/slot-2 main
```
